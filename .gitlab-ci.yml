stages:
   - build
   - test
   - deploy
   - build-pgi
   - test-pgi

build-gfortran:
  image: iffregistry.fz-juelich.de/fleur/fleur:latest
  stage: build
  cache: 
     paths:
       - build
  script:
    - cd /builds/fleur/fleur; ./configure.sh GITLAB; cd build; make 
test-gfortran:
  image: iffregistry.fz-juelich.de/fleur/fleur:latest
  stage: test
  cache:
     paths:
       - build
  script:
    - ulimit -s unlimited ;export juDFT_MPI="mpirun -n 2 --allow-run-as-root ";cd /builds/fleur/fleur/build;ctest

  
pages:
  image: iffregistry.fz-juelich.de/fleur/fleur:latest
  stage: deploy
  cache:
     paths:
       - build
  script:
    - cd /builds/fleur/fleur/build ; make doc
    - mv docs/html/ ../public/
  artifacts:
    paths:
      - public
      - build/fleur
      - build/fleur_MPI
      - build/inpgen
 

build-pgi:
  image: hopobcn/pgi-ce
  stage: build-pgi
  cache: 
     paths:
       - build.debug
  script:
    - apt-get update -qq && apt-get install -y -qq cmake libxml2-dev
    - cd /builds/fleur/fleur; ./configure.sh AUTO debug; cd build.debug; make 
  only:
    - schedules
    
test-pgi:
  image: hopobcn/pgi-ce
  stage: test-pgi
  cache:
     paths:
       - build.debug
  script:
    - apt-get update -qq && apt-get install -y -qq cmake libxml2-dev 
    - cd /builds/fleur/fleur/build.debug;ctest
  only:
     - schedules