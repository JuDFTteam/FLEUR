!--------------------------------------------------------------------------------
! Copyright (c) 2018 Peter Grünberg Institut, Forschungszentrum Jülich, Germany
! This file is part of FLEUR and avhttps://gcc.gnu.org/onlinedocs/gfortran/SQRT.htmlailable as free software under the conditions
! of the MIT license as expressed in the LICENSE file in more detail.
!------------------------------------------------------------------------------
!  This routine allows to rotate the cdn in a way that the direction of magnetization aligns with the direction of the spin quantization axis. 
!  This routine also allows to reverse the rotation by using the angles stored in atoms (phi_mt_avg,theta_mt_avg) which are generated by the 
!  routine magnMomFromDen. 
!
! Robin Hilgers, Nov '19
MODULE m_alignSpinAxisMagn


USE m_magnMomFromDen
USE m_types
USE m_flipcdn
USE m_constants
USE m_polangle
IMPLICIT NONE

CONTAINS
SUBROUTINE rotateMagnetToSpinAxis(vacuum,sphhar,stars&
,sym,oneD,cell,noco,input,atoms,den)
   TYPE(t_input), INTENT(INOUT)  :: input
   TYPE(t_atoms), INTENT(INOUT)  :: atoms
   TYPE(t_noco), INTENT(INOUT)   :: noco
   TYPE(t_stars),INTENT(IN)      :: stars
   TYPE(t_vacuum),INTENT(IN)     :: vacuum
   TYPE(t_sphhar),INTENT(IN)     :: sphhar
   TYPE(t_sym),INTENT(IN)        :: sym
   TYPE(t_oneD),INTENT(IN)       :: oneD
   TYPE(t_cell),INTENT(IN)       :: cell
   TYPE(t_potden), INTENT(INOUT) :: den 

   REAL                          :: moments(atoms%ntype,3)
   REAL                          :: phiTemp(atoms%ntype),thetaTemp(atoms%ntype),pi
   INTEGER                       :: i
   pi=pimach()   
!!TEMP
!   REAL :: x,y,z
   
   phiTemp=noco%alph
   thetaTemp=noco%beta
   CALL magnMomFromDen(input,atoms,noco,den,moments)
  ! DO i=1, atoms%ntype
     ! IF (abs(atoms%theta_mt_avg(i)).LE. 0.001) THEN 
     !    atoms%phi_mt_avg(i)=0.0
     !    atoms%theta_mt_avg(i)=0.0
     ! END IF
  ! END DO
   !write(*,*) "mx1"
   !write(*,*) moments(1,1)
   !write(*,*) "mz1"
   !write(*,*) moments(1,3)
   !write(*,*) "mx2"
   !write(*,*) moments(2,1)
   !write(*,*) "mz2"
   !write(*,*) moments(2,3)
   CALL flipcdn(atoms,input,vacuum,sphhar,stars,sym,noco,oneD,cell,-atoms%phi_mt_avg,-atoms%theta_mt_avg,den)
  !write (*,*)"mx                my                     mz"
  !CALL sphericaltocart(SQRT(moments(1,1)**2+moments(1,2)**2+moments(1,3)**2),thetaTemp(1),phiTemp(1),x,y,z)
   !write(*,*) x,y,z
   !CALL sphericaltocart(SQRT(moments(2,1)**2+moments(2,2)**2+moments(2,3)**2),thetaTemp(2),phiTemp(2),x,y,z)
   !write(*,*) x,y,z
   !write(*,*) "atoms%phi_mt_avg"
   !!write(*,*) atoms%phi_mt_avg
   !write(*,*) "atoms%theta_mt_avg"
   !write(*,*) atoms%theta_mt_avg
   noco%alph=mod(atoms%phi_mt_avg+phiTemp,2*pimach())
   noco%beta=mod(atoms%theta_mt_avg+thetaTemp,2*pimach())
   atoms%phi_mt_avg=noco%alph
   atoms%theta_mt_avg=noco%beta
 
   DO i=1, atoms%ntype
      IF(noco%alph(i)<0) noco%alph(i)=noco%alph(i)+2*pi
      IF(noco%beta(i)<0) THEN
         noco%beta(i)=-noco%beta(i) 
         noco%alph=noco%alph+pi 
END IF
      IF(noco%beta(i)>pi) THEN 
         noco%beta(i)=pi-mod(noco%beta(i),pi)
         noco%alph(i)=noco%alph(i)+pi
      END IF
      noco%alph=mod(noco%alph,2*pi)
   End Do
   write(*,*) "Noco Phi"
   write(*,*) noco%alph
   write(*,*) "Noco Theta"
   write(*,*) noco%beta
END SUBROUTINE rotateMagnetToSpinAxis


SUBROUTINE rotateMagnetFromSpinAxis(noco,vacuum,sphhar,stars&
,sym,oneD,cell,input,atoms,den,inDen)
   TYPE(t_input), INTENT(INOUT)  :: input
   TYPE(t_atoms), INTENT(INOUT)  :: atoms
   TYPE(t_noco), INTENT(INOUT)	 :: noco
   TYPE(t_stars),INTENT(IN)	 :: stars
   TYPE(t_vacuum),INTENT(IN)     :: vacuum
   TYPE(t_sphhar),INTENT(IN)     :: sphhar
   TYPE(t_sym),INTENT(IN)        :: sym
   TYPE(t_oneD),INTENT(IN)	 :: oneD
   TYPE(t_cell),INTENT(IN)	 :: cell
   TYPE(t_potden), INTENT(INOUT) :: den, inDen


   CALL flipcdn(atoms,input,vacuum,sphhar,stars,sym,noco,oneD,cell,atoms%phi_mt_avg,atoms%theta_mt_avg,den)
   CALL flipcdn(atoms,input,vacuum,sphhar,stars,sym,noco,oneD,cell,atoms%phi_mt_avg,atoms%theta_mt_avg,inDen)
  
   atoms%flipSpinPhi=0
   atoms%flipSpinTheta=0
   noco%alph=0
   noco%beta=0

END SUBROUTINE rotateMagnetFromSpinAxis


END MODULE m_alignSpinAxisMagn

