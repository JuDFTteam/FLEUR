include_directories("${CMAKE_CURRENT_BINARY_DIR}/include")
include_directories(include)


add_subdirectory("src/libraries/fleurinput")

set(c_filesFleur ${CMAKE_SOURCE_DIR}/src/fleur/io/xml/dropInputSchema.c 
${CMAKE_SOURCE_DIR}/src/fleur/io/xml/dropOutputSchema.c ${CMAKE_SOURCE_DIR}/src/fleur/io/xml/xmlInterfaceWrapper.c)


if(FLEUR_USE_PROG_THREAD)
   set(c_filesFleur ${c_filesFleur} hybrid/progress_thread/progress_thread.c)
endif()

set(fleur_F90 src/fleur/main/fleur.F90)
set(fleur_F77 "")
include(src/fleur/eigen/CMakeLists.txt)
include(src/fleur/force/CMakeLists.txt)
include(src/fleur/main/CMakeLists.txt)
include(src/fleur/core/CMakeLists.txt)
#include(src/fleur/eigen_secvar/CMakeLists.txt)
include(src/fleur/global/CMakeLists.txt)
include(src/fleur/io/CMakeLists.txt)
include(src/fleur/startden/CMakeLists.txt)
include(src/fleur/xc-pot/CMakeLists.txt)
include(src/fleur/cdn/CMakeLists.txt)
include(src/fleur/diagonalization/CMakeLists.txt)
include(src/fleur/eigen_soc/CMakeLists.txt)
include(src/fleur/math/CMakeLists.txt)
include(src/fleur/fft/CMakeLists.txt)
include(src/fleur/propcalc/orbdep/CMakeLists.txt)
include(src/fleur/cdn_mt/CMakeLists.txt)
include(src/fleur/propcalc/dos/CMakeLists.txt)
include(src/fleur/fermi/CMakeLists.txt)
include(src/fleur/init/CMakeLists.txt)
include(src/fleur/ldaX/CMakeLists.txt)
include(src/fleur/mix/CMakeLists.txt)
include(src/fleur/vgen/CMakeLists.txt)
include(src/fleur/mpi/CMakeLists.txt)
include(src/fleur/hybrid/CMakeLists.txt)
include(src/fleur/propcalc/eels/CMakeLists.txt)
include(src/fleur/types/CMakeLists.txt)
include(src/fleur/wannier/CMakeLists.txt)
include(src/fleur/wannier/uhu/CMakeLists.txt)
include(src/fleur/forcetheorem/CMakeLists.txt)
include(src/fleur/rdmft/CMakeLists.txt)
include(src/fleur/kpoints/CMakeLists.txt)
include(src/fleur/greensf/CMakeLists.txt)
include(src/fleur/tetra/CMakeLists.txt)
include(src/fleur/juphon/CMakeLists.txt)

include(docs/CMakeLists.txt)


set(fleur_SRC ${fleur_F90} ${fleur_F77})

set_source_files_properties(${fleur_F90} PROPERTIES Fortran_FORMAT FREE)
set_source_files_properties(${fleur_F77} PROPERTIES Fortran_FORMAT FIXED)

include_directories("${CMAKE_CURRENT_BINARY_DIR}/fleurinput/modules/fleurinput")
if (FLEUR_USE_SERIAL)
   #Serial executables
   add_executable(fleur ${fleur_SRC} ${c_filesFleur})
   target_compile_definitions(fleur PUBLIC ${FLEUR_DEFINITIONS})
   target_compile_options(fleur PUBLIC $<$<COMPILE_LANGUAGE:Fortran>:${FLEUR_PRECISION_OPTION}>)
   target_link_libraries(fleur fleurinput juDFT)
   if (FLEUR_COMPILE_EDSOLVER)
      target_link_libraries(fleur EDsolver)
   endif()
   target_link_libraries(fleur ${FLEUR_LIBRARIES})
   target_link_libraries(fleur ${FLEUR_LINK_LIBRARIES})
   get_property(CO SOURCE main/fleur.F90 PROPERTY COMPILE_FLAGS)
   message("1:${CO}")
   target_compile_options(fleur PRIVATE $<$<COMPILE_LANGUAGE:Fortran>:${FLEUR_COMPILE_OPTIONS}>)
   target_compile_options(fleur PRIVATE -Imodules/fleur)
   set_target_properties(fleur PROPERTIES Fortran_MODULE_DIRECTORY modules/fleur)
endif()
#parallel executables
if (FLEUR_USE_MPI)
  #fleur_MPI
  add_executable(fleur_MPI ${juDFT_HDF} ${juDFT_SRC_F90} ${fleur_SRC} ${c_filesFleur} ${fleur_SRC_MPI})
  target_compile_definitions(fleur_MPI PUBLIC ${FLEUR_MPI_DEFINITIONS})
  target_link_libraries(fleur_MPI fleurinput juDFT)
  target_compile_options(fleur_MPI PUBLIC $<$<COMPILE_LANGUAGE:Fortran>:${FLEUR_PRECISION_OPTION}>)
  target_compile_options(fleur_MPI PUBLIC $<$<COMPILE_LANGUAGE:Fortran>:${FLEUR_COMPILE_OPTIONS}>)
   if (FLEUR_COMPILE_EDSOLVER)
      target_link_libraries(fleur_MPI EDsolver)
   endif()
   if (FLEUR_COMPILE_ELSI)
      target_link_libraries(fleur_MPI elsi)
      set_target_properties(fleur_MPI PROPERTIES LINKER_LANGUAGE Fortran)
   endif()
   IF (FLEUR_COMPILE_SCALAPACK)
      target_link_libraries(fleur_MPI scalapack)
      if (FLEUR_COMPILE_ELSI)
      cmake_policy(SET CMP0079 NEW)
      target_link_libraries(elpa PRIVATE scalapack)
      target_link_libraries(chase PRIVATE scalapack)
      endif()
   endif()
  target_link_libraries(fleur_MPI ${FLEUR_LIBRARIES})
  target_link_libraries(fleur_MPI ${FLEUR_LINK_LIBRARIES})
  set_target_properties(fleur_MPI PROPERTIES Fortran_MODULE_DIRECTORY modules/fleur_MPI)
  target_compile_options(fleur_MPI PUBLIC -Imodules/fleur_MPI)
  if (FLEUR_USE_INTERNAL_ELPA)
     add_dependencies(fleur_MPI ELPA)
  endif()
endif ()



include(cmake/docker.txt)


#if (FLEUR_USE_SERIAL)
#install(TARGETS fleur inpgen
#        CONFIGURATIONS Release
#        DESTINATION bin)
#endif()
#if (FLEUR_USE_MPI)
#install(TARGETS fleur_MPI
#        CONFIGURATIONS Release
#        DESTINATION bin)
#endif()

add_subdirectory("src/tools/inpgen2")

# HACK! to ensure buildinfo.h gets regenerated before inpgen2 gets built
if (FLEUR_USE_SERIAL)
   add_dependencies("inpgen2" fleur)
endif()
if (FLEUR_USE_MPI)
   add_dependencies("inpgen2" fleur_MPI)
endif ()
