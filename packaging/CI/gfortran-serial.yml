build-gfortran-serial:
  image: iffregistry.fz-juelich.de/fleur/fleur:gfortran
  stage: build
  script:
    - cd $CI_PROJECT_DIR
    - ./configure.sh -l serial -mpi FALSE -hdf5 FALSE -cmake_opts -DFLEUR_USE_OPENMP=OFF
    - cd build.serial
    - make -j 2
  artifacts:
    paths:
      - build.serial
    expire_in: 12h
  rules:
    - if: $CI_TASKS =~ /serial/    
    - if: $CI_TASKS =~ /all/    
  
build-gfortran-hdf5-serial:
  image: iffregistry.fz-juelich.de/fleur/fleur:gfortran
  stage: build
  artifacts:
     paths:
       - build
     expire_in: 12h
  script:
    - cd $CI_PROJECT_DIR
    - FLEUR_INCLUDEDIR="/opt/include /usr/include" FLEUR_LIBRARIES="-L/opt/lib;-ldl;-L/usr/lib;-L/usr/lib/x86_64-linux-gnu;-lscalapack-openmpi;-lfftw3" ./configure.sh -c mpi -mpi FALSE
    - cd build
    - make -j 2
  rules:
      - if: $CI_TASKS =~ /serial/    
      - if: $CI_TASKS =~ /all/    

test-gfortran-serial:
  image: iffregistry.fz-juelich.de/fleur/fleur:gfortran
  extends: .test-fleur
  needs: 
    - build-gfortran-serial
  variables:
    BUILD_FOLDER: build.serial
  rules:
    - if: $CI_TASKS =~ /serial/    
    - if: $CI_TASKS =~ /all/    
  
  
build-gfortran-hdf5-debug:
  image: iffregistry.fz-juelich.de/fleur/fleur:gfortran
  stage: build
  artifacts:
     paths:
       - build.debug
     expire_in: 12h
  script:
    - cd $CI_PROJECT_DIR
    - FLEUR_INCLUDEDIR="/opt/include /usr/include" FLEUR_LIBRARIES="-L/opt/lib;-ldl;-L/usr/lib;-L/usr/lib/x86_64-linux-gnu;-lscalapack-openmpi;-lfftw3" ./configure.sh -c mpi -mpi FALSE -d -flags "-fcheck=all -finit-real=snan -finit-derived"
    - cd build.debug
    - make -j 2
  rules:
      - if: $CI_TASKS =~ /debug/    
      - if: $CI_TASKS =~ /all/    

test-gfortran-serial-debug:
  image: iffregistry.fz-juelich.de/fleur/fleur:gfortran
  extends: .test-fleur
  needs: 
    - build-gfortran-hdf5-debug
  variables:
    BUILD_FOLDER: build.debug
  rules:
    - if: $CI_TASKS =~ /debug/    
    - if: $CI_TASKS =~ /all/    
  
